#!/bin/sh
# Copyright (c) 2008 Volker Theile (votdev@gmx.de)
# All rights reserved.

# PROVIDE: nut_upsmon
# REQUIRE: NETWORKING nut
# BEFORE: LOGIN
# KEYWORD: shutdown
# XQUERY: -i "count(//ups/enable) > 0" -o "0" -b
# RCVAR: nut_upsmon

. /etc/rc.subr
. /etc/configxml.subr

name="nut_upsmon"
rcvar=`set_rcvar`

load_rc_config "${name}"

# Custom commands
extra_commands="mkconf"
mkconf_cmd="mkconf_cmd"

# Defaults
nut_upsmon_enable=${nut_upsmon_enable:-"NO"}
nut_upsmon_prefix=${nut_upsmon_prefix:-"/usr/local"}
nut_upsmon_conf=${nut_upsmon_conf:-"/var/etc/upsmon.conf"}
nut_upsmon_powerdownflag=${nut_upsmon_powerdownflag:-"/var/etc/killpower"}
nut_upsmon_sched_conf=${nut_upsmon_sched_conf:-"/var/etc/upssched.conf"}
nut_upsmon_runas=${nut_upsmon_runas:-"root"}
nut_upsmon_user=${nut_upsmon_user:-"root"}
nut_upsmon_password=${nut_upsmon_password:-"freenas"}
nut_upsmon_flags=${nut_upsmon_flags:-"-u ${nut_upsmon_runas} localhost"}
nut_upsmon_notifycmd=${nut_upsmon_notifycmd:-"/usr/local/sbin/upssched"}
nut_upsmon_onbatt_shutdown_timer=${nut_upsmon_onbatt_shutdown_timer:-"30"}

required_dirs="/var/run"
required_files="${nut_upsmon_conf}"
command="${nut_upsmon_prefix}/sbin/upsmon"
pidfile="/var/run/upsmon.pid"

mkconf_cmd()
{
	local _upsname _notifyflags

	# Get identifier.
	_upsname=`configxml_get "//ups/upsname"`

	# Build notification flags
	_notifyflags=`/usr/local/bin/xml sel -t \
		-o "SYSLOG+WALL" \
		-i "count(//ups/email/enable) > 0" -o "+EXEC" -b \
		${configxml_file} | /usr/local/bin/xml unesc`

	# Create upsmon.conf
	cat <<EOF > ${nut_upsmon_conf}
MONITOR ${_upsname}@localhost 1 ${nut_upsmon_user} ${nut_upsmon_password} master
MINSUPPLIES 1
SHUTDOWNCMD "/sbin/shutdown -h +0"
NOTIFYCMD ${nut_upsmon_notifycmd}
POLLFREQ 5
POLLFREQALERT 5
HOSTSYNC 15
DEADTIME 15
POWERDOWNFLAG ${nut_upsmon_powerdownflag}
NOTIFYFLAG ONLINE ${_notifyflags}
NOTIFYFLAG ONBATT ${_notifyflags}
NOTIFYFLAG LOWBATT ${_notifyflags}
NOTIFYFLAG COMMOK ${_notifyflags}
NOTIFYFLAG COMMBAD ${_notifyflags}
NOTIFYFLAG SHUTDOWN ${_notifyflags}
NOTIFYFLAG REPLBATT ${_notifyflags}
NOTIFYFLAG NOCOMM ${_notifyflags}
NOTIFYFLAG FSD ${_notifyflags}
RBWARNTIME 43200
NOCOMMWARNTIME 300
FINALDELAY 5
EOF

	# Create upssched.conf
	cat <<EOF > ${nut_upsmon_sched_conf}
CMDSCRIPT /usr/local/bin/upssched-cmd
PIPEFN /var/run/upssched.pipe
LOCKFN /var/run/upssched.lock

AT ONLINE * CANCEL-TIMER early-shutdown 
AT ONLINE * EXECUTE resume
AT ONBATT * START-TIMER early-shutdown ${nut_upsmon_onbatt_shutdown_timer}
AT ONBATT * EXECUTE early-warning
AT LOWBATT * START-TIMER early-shutdown
AT LOWBATT * EXECUTE early-warning 
AT COMMBAD * EXECUTE bad-communication
AT REPLBATT * EXECUTE replace-battery
AT NOCOMM * EXECUTE no-communication
AT FSD * EXECUTE forced-shutdown
EOF

	chmod 0600 ${nut_upsmon_conf}
	chmod 0600 ${nut_upsmon_sched_conf}
}

# Create required config file
mkconf_cmd

run_rc_command "$1"
