#!/bin/sh
# Copyright (c) 2008 Volker Theile (votdev@gmx.de)
# All rights reserved.

. /etc/rc.subr
. /etc/configxml.subr

# Defaults
msmtp_config=${msmtp_config:-"/var/etc/msmtp.conf"}
msmtp_msgfile=${msmtp_msgfile:-"/tmp/message"}
nut_upssched_forced_shutdown_timer=${nut_upssched_forced_shutdown_timer:-"2"}

case "${1}" in
	early-warning)
		_message="Early shutdown imminent";;

	early-shutdown)
		_message="Early shutdown";
		shutdown -h now powerevent;;

	resume)
		_message="Early shutdown cancelled";;

	forced-shutdown)
		_message="Forced shutdown";
		shutdown -h +${nut_upssched_forced_shutdown_timer} powerevent-forced;;

	replace-battery)
		_message="Replace UPS battery";;

	bad-communication)
		_message="Bad communication";;

	no-communication)
		_message="No communication";;

	*)
		_message="Unknown command: ${1}";
esac

# Write message to syslog
logger -t upssched-cmd "${_message}"

# Send email if feature is set
if configxml_isset //ups/email/enable; then
	# Get recipients
	_recipients=`configxml_get "//ups/email/to" | /usr/bin/tr ";" " "`

	# Create message
	echo ${_recipients} | awk '{for ( i = NF ; i > 0 ; --i ) printf("To: %s\n",$i)}' > ${msmtp_msgfile}

	/usr/local/bin/xml sel -t \
		-v "concat('From: ',//system/email/from)" -n \
		-v "concat('Subject: ',//ups/email/subject)" -n \
		-o "." -n \
		${configxml_file} | /usr/local/bin/xml unesc >> ${msmtp_msgfile}

	echo "${_message}" >> ${msmtp_msgfile}

	# Now email the message to the user
	/usr/local/bin/msmtp --file=${msmtp_config} ${_recipients} < ${msmtp_msgfile} 1>/dev/null 2>&1

	# Cleanup
	/bin/rm ${msmtp_msgfile} 1>/dev/null 2>&1
fi
