#!/bin/sh
# Copyright (c) 2008 Volker Theile (votdev@gmx.de)
# All rights reserved.

. /etc/rc.subr
. /etc/configxml.subr

name="upssched-cmd"

load_rc_config "${name}"

# Defaults
msmtp_config=${msmtp_config:-"/var/etc/msmtp.conf"}
msmtp_msgfile=${msmtp_msgfile:-"/tmp/message"}
nut_upssched_forced_shutdown_timer=${nut_upssched_forced_shutdown_timer:-"2"}

case "${NOTIFYTYPE}" in
	ONLINE)
		_notifymessage="UPS ${UPSNAME} on line power";;
	ONBATT)
		_notifymessage="UPS ${UPSNAME} on battery";;
	LOWBATT)
		_notifymessage="UPS ${UPSNAME} battery is low";;
	FSD)
		_notifymessage="UPS ${UPSNAME}: forced shutdown in progress";;
	COMMOK)
		_notifymessage="Communications with UPS ${UPSNAME} established";;
	COMMBAD)
		_notifymessage="Communications with UPS ${UPSNAME} lost";;
	SHUTDOWN)
		_notifymessage="Auto logout and shutdown proceeding";;
	REPLBATT)
		_notifymessage="UPS ${UPSNAME} battery needs to be replaced";;
	NOCOMM)
		_notifymessage="UPS ${UPSNAME} is unavailable";;
	NOPARENT)
		_notifymessage="upsmon parent process died - shutdown impossible";;
esac

case "${1}" in
	early-warning)
		_message="${_notifymessage}.
Early shutdown imminent in ${nut_upsmon_onbatt_shutdown_timer} seconds.";;

	early-shutdown)
		_message="${_notifymessage}.
Early shutdown.";
		shutdown -h now powerevent;;

	resume)
		_message="${_notifymessage}.
Early shutdown cancelled.";;

	forced-shutdown)
		_message="${_notifymessage}.
Forced shutdown imminent in ${nut_upssched_forced_shutdown_timer} minutes.";
		shutdown -h +${nut_upssched_forced_shutdown_timer} powerevent-forced;;

	replace-battery)
		_message="${_notifymessage}";;

	bad-communication)
		_message="${_notifymessage}";;

	no-communication)
		_message="${_notifymessage}";;

	*)
		_message="Unknown command: ${1}";
esac

# Write message to syslog
logger -t upssched-cmd "${_message}"

# Send email if feature is enabled
if configxml_isset //ups/email/enable; then
	# Get recipients
	_recipients=`configxml_get "//ups/email/to" | /usr/bin/tr ";" " "`

	# Create message
	echo ${_recipients} | awk '{for ( i = NF ; i > 0 ; --i ) printf("To: %s\n",$i)}' > ${msmtp_msgfile}

	/usr/local/bin/xml sel -t \
		-v "concat('From: ',//system/email/from)" -n \
		-v "concat('Subject: ',//ups/email/subject)" -n \
		-o "." -n \
		${configxml_file} | /usr/local/bin/xml unesc >> ${msmtp_msgfile}

	echo "${_message}" >> ${msmtp_msgfile}

	# Now email the message to the user
	/usr/local/bin/msmtp --file=${msmtp_config} ${_recipients} < ${msmtp_msgfile} 1>/dev/null 2>&1

	# Cleanup
	/bin/rm ${msmtp_msgfile} 1>/dev/null 2>&1
fi
