#!/bin/sh
# Copyright Â© 2007 Volker Theile (votdev@gmx.de)
# All rights reserved.

# PROVIDE: syslogd
# REQUIRE: mountcritlocal
# BEFORE: SERVERS

. /etc/rc.subr
. /etc/configxml.subr

name="syslogd"
rcvar=`set_rcvar`

# Defaults
syslogd_enable=${syslogd_enable:-"NO"}
syslogd_config=${syslogd_config:-"/var/etc/${name}.conf"}
pidfile="/var/run/syslog.pid"
command="/usr/sbin/${name}"
command_args="-f ${syslogd_config}"

# Custom commands
start_precmd="start_precmd"
extra_commands="reload"
reload_precmd="reload_precmd"

load_rc_config ${name}

# Check if syslog'ing to remote syslog server is disabled.
if ! configxml_isset //syslogd/remote/enable; then
	syslogd_flags="-ss"
	command_args="-f ${syslogd_config}"
fi

create_conf()
{
	echo "local3.* %/var/log/sshd.log
local4.* %/var/log/rsyncd.log
local5.* %/var/log/smartd.log
ftp.* %/var/log/ftp.log
daemon.* %/var/log/daemon.log
*.notice;kern.debug;lpr.info;mail.crit;news.err;local0.none;local7.none %/var/log/system.log
security.* %/var/log/system.log
auth.info;authpriv.info %/var/log/system.log
*.emerg *" > ${syslogd_config}

	# Add remote server configuration if syslog'ing to remote syslog server is enabled.
	/usr/local/bin/xml sel -t \
		-i "//syslogd/remote/enable" \
			-i "//syslogd/remote/ftp" \
				-o "ftp.* @" -v "//syslogd/remote/ipaddr" -n -b \
			-i "//syslogd/remote/sshd" \
				-o "local3.* @" -v "//syslogd/remote/ipaddr" -n -b \
			-i "//syslogd/remote/rsyncd" \
				-o "local4.* @" -v "//syslogd/remote/ipaddr" -n -b \
			-i "//syslogd/remote/smartd" \
				-o "local5.* @" -v "//syslogd/remote/ipaddr" -n -b \
			-i "//syslogd/remote/daemon" \
				-o "daemon.* @" -v "//syslogd/remote/ipaddr" -n -b \
			-i "//syslogd/remote/system" \
				-o "*.notice;kern.debug;lpr.info;mail.crit;news.err;local0.none;local7.none @" -v "//syslogd/remote/ipaddr" -n \
				-o "security.* @" -v "//syslogd/remote/ipaddr" -n \
				-o "auth.info;authpriv.info @" -v "//syslogd/remote/ipaddr" -n \
				-o "*.emerg	@" -v "//syslogd/remote/ipaddr" -n -b \
		-b \
		${configxml_file} >> ${syslogd_config}
}

reload_precmd()
{
	# Clear existing file.
	cat /dev/null > ${syslogd_config}

	# Create configuration file.
	create_conf
}

start_precmd()
{
	reload_precmd
}

run_rc_command "$1"
