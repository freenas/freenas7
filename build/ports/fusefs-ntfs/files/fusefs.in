#!/bin/sh
# Copyright (c) 2008 Volker Theile (votdev@gmx.de)
# All rights reserved.

# PROVIDE: fusefs
# REQUIRE: sysctl
# BEFORE: mountcritlocal
# KEYWORD: shutdown
# XQUERY: -i "count(//mounts/mount/fstype[. = 'ntfs']) > 0" -o "0" -b
# RCVAR: fusefs

. /etc/rc.subr
. /etc/configxml.subr

name="fusefs"
rcvar=`set_rcvar`

# Custom commands
start_cmd="fusefs_start"
stop_cmd="fusefs_stop"

# Defaults
fusefs_enable=${fusefs_enable:-"NO"}
kmod="/boot/kernel/fuse.ko"

fusefs_start()
{
	if kldstat | grep -q fuse\\.ko; then
		echo "${name} is already running."
		return 0
	fi
	echo "Starting ${name}."
	kldload $kmod
}

fusefs_stop()
{
	if ! kldstat | grep -q fuse\\.ko; then
		echo "${name} is not running."
		return 1
	fi
	echo "Stopping ${name}."
# Unmount FUSE filesystems in reverse order (in case they are nested) with
# a delay of one second after, to allow 'umount' finish.
	mount | sed -e '1!G;h;$!d' | while read dev d1 mountpoint d2; do
		case "$dev" in
		/dev/fuse[0-9]*)
			echo "fusefs: unmounting ${mountpoint}."
			umount $mountpoint ; sleep 1
			;;
		esac
	done
# Delay of one second, otherwise kldunload fails because of busy device(s).
	sleep 1
	kldunload $kmod
}

load_rc_config $name
run_rc_command "$1"
